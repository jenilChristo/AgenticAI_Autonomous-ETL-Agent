{% extends "base.html" %}

{% block title %}Create Project{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-plus"></i> Create New Project</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('projects') }}">Projects</a></li>
                <li class="breadcrumb-item active">Create Project</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Project Information</h5>
            </div>
            <div class="card-body">
                <form id="createProjectForm" action="{{ url_for('create_project') }}" method="POST">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    Project Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="name" name="name" required 
                                       placeholder="Enter project name">
                                <div class="form-text">Choose a descriptive name for your data engineering project</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="key" class="form-label">
                                    Project Key <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="key" name="key" required 
                                       placeholder="PROJ" pattern="[A-Z]{2,10}" maxlength="10">
                                <div class="form-text">2-10 uppercase letters (e.g., PROJ, ETL, DATA)</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4" 
                                  placeholder="Describe your project's objectives, data sources, and goals"></textarea>
                        <div class="form-text">Provide details about the project scope and objectives</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="status" class="form-label">Initial Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="New" selected>New</option>
                                    <option value="Active">Active</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="template" class="form-label">Project Template</label>
                                <select class="form-select" id="template" name="template">
                                    <option value="">None - Start from scratch</option>
                                    <option value="data_warehouse">Data Warehouse ETL</option>
                                    <option value="real_time">Real-time Streaming</option>
                                    <option value="ml_pipeline">ML Pipeline</option>
                                    <option value="data_lake">Data Lake Processing</option>
                                </select>
                                <div class="form-text">Choose a template to get started with pre-configured stories</div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings (Collapsible) -->
                    <div class="mb-3">
                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#advancedSettings" aria-expanded="false">
                            <i class="fas fa-cog"></i> Advanced Settings
                        </button>
                    </div>

                    <div class="collapse" id="advancedSettings">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6>ETL Agent Configuration</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="default_llm" class="form-label">Default LLM Provider</label>
                                            <select class="form-select" id="default_llm" name="default_llm">
                                                <option value="openai" selected>OpenAI GPT-4</option>
                                                <option value="anthropic">Anthropic Claude</option>
                                                <option value="ollama">Ollama (Local)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="auto_run_etl" class="form-label">ETL Agent Behavior</label>
                                            <select class="form-select" id="auto_run_etl" name="auto_run_etl">
                                                <option value="manual" selected>Manual execution</option>
                                                <option value="auto">Auto-run on story creation</option>
                                                <option value="scheduled">Scheduled execution</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <h6 class="mt-3">GitHub Integration</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="github_repo" class="form-label">GitHub Repository</label>
                                            <input type="text" class="form-control" id="github_repo" name="github_repo" 
                                                   placeholder="owner/repository-name">
                                            <div class="form-text">Link this project to a GitHub repository</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="github_branch" class="form-label">Default Branch</label>
                                            <input type="text" class="form-control" id="github_branch" name="github_branch" 
                                                   placeholder="main" value="main">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto_sync_github" name="auto_sync_github">
                                    <label class="form-check-label" for="auto_sync_github">
                                        Automatically sync issues from GitHub
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('projects') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-azure">
                            <i class="fas fa-plus"></i> Create Project
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Project Preview -->
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-eye"></i> Project Preview</h6>
            </div>
            <div class="card-body">
                <div class="project-preview">
                    <h6 id="previewName" class="text-azure">Project Name</h6>
                    <div class="mb-2">
                        <small class="text-muted">Key:</small> 
                        <code id="previewKey">PROJ</code>
                    </div>
                    <p id="previewDescription" class="text-muted small">
                        Project description will appear here...
                    </p>
                    <div class="mb-2">
                        <small class="text-muted">Status:</small>
                        <span id="previewStatus" class="badge bg-primary">New</span>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Template:</small>
                        <span id="previewTemplate" class="text-secondary">None</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Template Information -->
        <div class="card mt-3" id="templateInfo" style="display: none;">
            <div class="card-header">
                <h6><i class="fas fa-info"></i> Template Features</h6>
            </div>
            <div class="card-body">
                <div id="templateDetails"></div>
            </div>
        </div>

        <!-- Getting Started Tips -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb"></i> Getting Started</h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <h6>After creating your project:</h6>
                    <ol class="mb-0">
                        <li><strong>Create User Stories:</strong> Add stories that describe your data processing requirements</li>
                        <li><strong>Link GitHub Issues:</strong> Connect existing GitHub issues to stories</li>
                        <li><strong>Run ETL Agent:</strong> Let the AI generate PySpark code automatically</li>
                        <li><strong>Review & Deploy:</strong> Test and deploy the generated code</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- ETL Agent Capabilities -->
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-robot"></i> ETL Agent Features</h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2">
                        <i class="fas fa-check text-success"></i> 
                        <strong>Code Generation:</strong> Automatic PySpark pipeline creation
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-check text-success"></i> 
                        <strong>Task Breakdown:</strong> Requirements analysis and task planning
                    </div>
                    <div class="mb-2">
                        <i class="fas fa-check text-success"></i> 
                        <strong>GitHub Integration:</strong> Issue parsing and PR creation
                    </div>
                    <div class="mb-0">
                        <i class="fas fa-check text-success"></i> 
                        <strong>Best Practices:</strong> Production-ready code with error handling
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Template information
const templateInfo = {
    'data_warehouse': {
        name: 'Data Warehouse ETL',
        description: 'Pre-configured for traditional ETL workflows with batch processing, data validation, and warehouse loading patterns.',
        features: [
            'Extract from multiple sources (databases, files)',
            'Data quality validation and cleansing',
            'Dimensional modeling patterns',
            'Incremental loading strategies',
            'Data lineage tracking'
        ]
    },
    'real_time': {
        name: 'Real-time Streaming',
        description: 'Optimized for streaming data pipelines with Kafka, Spark Streaming, and real-time analytics.',
        features: [
            'Kafka integration patterns',
            'Stream processing with Spark Streaming',
            'Real-time aggregations',
            'Event-driven architecture',
            'Low-latency processing'
        ]
    },
    'ml_pipeline': {
        name: 'ML Pipeline',
        description: 'Designed for machine learning workflows with feature engineering, model training, and deployment.',
        features: [
            'Feature engineering pipelines',
            'Data preprocessing for ML',
            'Model training integration',
            'MLflow experiment tracking',
            'Batch and online inference'
        ]
    },
    'data_lake': {
        name: 'Data Lake Processing',
        description: 'Built for data lake architectures with schema-on-read, partitioning, and multi-format support.',
        features: [
            'Multi-format data ingestion (Parquet, Delta, JSON)',
            'Schema evolution support',
            'Partitioning strategies',
            'Data cataloging',
            'Cost-optimized storage patterns'
        ]
    }
};

// Live preview updates
document.getElementById('name').addEventListener('input', function() {
    document.getElementById('previewName').textContent = this.value || 'Project Name';
});

document.getElementById('key').addEventListener('input', function() {
    document.getElementById('previewKey').textContent = this.value || 'PROJ';
});

document.getElementById('description').addEventListener('input', function() {
    document.getElementById('previewDescription').textContent = this.value || 'Project description will appear here...';
});

document.getElementById('status').addEventListener('change', function() {
    const badge = document.getElementById('previewStatus');
    badge.textContent = this.value;
    badge.className = 'badge bg-' + (this.value === 'New' ? 'primary' : this.value === 'Active' ? 'success' : 'warning');
});

document.getElementById('template').addEventListener('change', function() {
    const templateName = this.value;
    const preview = document.getElementById('previewTemplate');
    const infoCard = document.getElementById('templateInfo');
    
    if (templateName && templateInfo[templateName]) {
        preview.textContent = templateInfo[templateName].name;
        
        // Show template info
        const details = document.getElementById('templateDetails');
        details.innerHTML = `
            <p class="small text-muted">${templateInfo[templateName].description}</p>
            <h6>Includes:</h6>
            <ul class="small mb-0">
                ${templateInfo[templateName].features.map(feature => `<li>${feature}</li>`).join('')}
            </ul>
        `;
        infoCard.style.display = 'block';
    } else {
        preview.textContent = 'None';
        infoCard.style.display = 'none';
    }
});

// Auto-generate project key from name
document.getElementById('name').addEventListener('input', function() {
    const keyInput = document.getElementById('key');
    if (!keyInput.value) {
        // Generate key from project name
        let key = this.value
            .toUpperCase()
            .replace(/[^A-Z\s]/g, '')
            .split(' ')
            .map(word => word.substring(0, 3))
            .join('')
            .substring(0, 10);
        
        keyInput.value = key;
        document.getElementById('previewKey').textContent = key || 'PROJ';
    }
});

// Form validation
document.getElementById('createProjectForm').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const key = document.getElementById('key').value.trim();
    
    if (!name) {
        e.preventDefault();
        showAlert('Project name is required', 'danger');
        document.getElementById('name').focus();
        return;
    }
    
    if (!key || key.length < 2) {
        e.preventDefault();
        showAlert('Project key must be at least 2 characters', 'danger');
        document.getElementById('key').focus();
        return;
    }
    
    if (!/^[A-Z]{2,10}$/.test(key)) {
        e.preventDefault();
        showAlert('Project key must contain only uppercase letters (2-10 characters)', 'danger');
        document.getElementById('key').focus();
        return;
    }
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Project...';
    submitBtn.disabled = true;
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

// Key input validation
document.getElementById('key').addEventListener('input', function() {
    this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '');
});
</script>
{% endblock %}