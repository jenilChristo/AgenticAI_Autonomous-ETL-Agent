{% extends "base.html" %}

{% block title %}Create User Story - DevOps Interface{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-plus"></i> Create User Story</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="project_id" class="form-label">Project</label>
                                <select class="form-select" id="project_id" name="project_id" required>
                                    <option value="">Select a project...</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- GitHub Integration -->
                    <div class="card mb-4" style="background-color: #f8f9fa;">
                        <div class="card-body">
                            <h6><i class="fab fa-github"></i> GitHub Integration (Optional)</h6>
                            <div class="mb-3">
                                <label for="github_issue_url" class="form-label">GitHub Issue URL</label>
                                <input type="url" class="form-control" id="github_issue_url" name="github_issue_url" 
                                       placeholder="https://github.com/owner/repo/issues/123"
                                       onblur="fetchGitHubIssue()">
                                <div class="form-text">
                                    Paste a GitHub issue URL to automatically populate title and description
                                </div>
                            </div>
                            <div id="github-status"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label">Title *</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="Low">Low</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="High">High</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="6" 
                                  placeholder="As a [user type], I want [functionality] so that [benefit]..."></textarea>
                        <div class="form-text">
                            Describe the user story in detail. Include requirements, data sources, and expected outcomes.
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="acceptance_criteria" class="form-label">Acceptance Criteria</label>
                        <textarea class="form-control" id="acceptance_criteria" name="acceptance_criteria" rows="4"
                                  placeholder="Given [context], When [action], Then [outcome]..."></textarea>
                        <div class="form-text">
                            Define specific conditions that must be met for the story to be considered complete.
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="story_points" class="form-label">Story Points</label>
                                <input type="number" class="form-control" id="story_points" name="story_points" 
                                       min="0" max="100" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="assigned_to" class="form-label">Assigned To</label>
                                <input type="text" class="form-control" id="assigned_to" name="assigned_to" 
                                       placeholder="@username or team">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ETL Agent Integration Notice -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-robot"></i> ETL Agent Integration</h6>
                        <p class="mb-0">
                            After creating this story, you can click <strong>"Process with ETL Agent"</strong> to:
                        </p>
                        <ul class="mb-0 mt-2">
                            <li>Automatically analyze the requirements</li>
                            <li>Generate actionable tasks</li>
                            <li>Create production-ready PySpark code</li>
                            <li>Set up testing framework</li>
                        </ul>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-azure">
                            <i class="fas fa-save"></i> Create User Story
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function fetchGitHubIssue() {
    const urlInput = document.getElementById('github_issue_url');
    const statusDiv = document.getElementById('github-status');
    const titleInput = document.getElementById('title');
    const descriptionInput = document.getElementById('description');
    
    const githubUrl = urlInput.value.trim();
    if (!githubUrl) {
        statusDiv.innerHTML = '';
        return;
    }
    
    // Validate GitHub URL format
    const githubRegex = /https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/issues\/(\d+)/;
    const match = githubUrl.match(githubRegex);
    
    if (!match) {
        statusDiv.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Invalid GitHub URL format</div>';
        return;
    }
    
    const [, owner, repo, issueNumber] = match;
    
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Fetching GitHub issue...</div>';
    
    try {
        // Note: In a real implementation, this would go through your backend to avoid CORS
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/issues/${issueNumber}`);
        
        if (response.ok) {
            const issue = await response.json();
            
            // Auto-populate fields if they're empty
            if (!titleInput.value.trim()) {
                titleInput.value = issue.title;
            }
            if (!descriptionInput.value.trim()) {
                descriptionInput.value = issue.body || '';
            }
            
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check"></i> 
                    Successfully fetched: <strong>${issue.title}</strong>
                    <br><small>Issue #${issueNumber} in ${owner}/${repo}</small>
                </div>
            `;
        } else {
            throw new Error(`GitHub API returned ${response.status}`);
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                Could not fetch GitHub issue. You can still create the story manually.
                <br><small>Note: Make sure the repository is public or you have access.</small>
            </div>
        `;
    }
}
</script>
{% endblock %}