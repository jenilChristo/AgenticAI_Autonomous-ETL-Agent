{% extends "base.html" %}

{% block title %}Generated Notebook - {{ story.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-code"></i> Generated Notebook</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('story_detail', story_id=story.id) }}">{{ story.title }}</a></li>
                <li class="breadcrumb-item active">Notebook</li>
            </ol>
        </nav>
    </div>
    <div>
        <a href="{{ url_for('story_detail', story_id=story.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Back to Story
        </a>
    </div>
</div>

<!-- Story Info -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <h5>{{ story.title }}</h5>
                <p class="text-muted mb-0">{{ story.description[:100] }}...</p>
            </div>
            <div class="col-md-4 text-end">
                <span class="badge bg-success">
                    <i class="fas fa-robot"></i> Generated by ETL Agent
                </span>
                <br><small class="text-muted">{{ story.updated_date.strftime('%B %d, %Y at %I:%M %p') }}</small>
            </div>
        </div>
    </div>
</div>

<!-- File Navigation -->
{% if notebook_files %}
<div class="card mb-4">
    <div class="card-header">
        <h6><i class="fas fa-folder"></i> Generated Files ({{ notebook_files|length }})</h6>
    </div>
    <div class="card-body">
        <div class="row">
            {% for filename in notebook_files.keys() %}
            <div class="col-md-3 mb-2">
                <button class="btn btn-outline-primary btn-sm w-100" onclick="showFile('{{ filename }}')">
                    <i class="fas fa-file-code"></i> {{ filename }}
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- File Content Display -->
{% for filename, content in notebook_files.items() %}
<div class="card mb-4 file-content" id="file-{{ filename }}" {% if not loop.first %}style="display: none;"{% endif %}>
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6><i class="fas fa-file-code"></i> {{ filename }}</h6>
        <div>
            <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('{{ filename }}')">
                <i class="fas fa-copy"></i> Copy
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="downloadFile('{{ filename }}')">
                <i class="fas fa-download"></i> Download
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        {% if filename.endswith('.py') or filename.endswith('.yaml') or filename.endswith('.yml') %}
        <pre class="code-block mb-0" id="content-{{ filename }}"><code>{{ content }}</code></pre>
        {% elif filename.endswith('.md') %}
        <div class="p-3">
            <div class="markdown-content">{{ content | replace('\n', '<br>') | safe }}</div>
        </div>
        {% elif filename.endswith('.txt') %}
        <pre class="code-block mb-0" id="content-{{ filename }}">{{ content }}</pre>
        {% else %}
        <div class="p-3">
            <div class="text-muted">
                <i class="fas fa-file"></i> {{ filename }} ({{ content|length }} characters)
            </div>
            <pre class="code-block mt-2" id="content-{{ filename }}">{{ content }}</pre>
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}

{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
        <h4>No Notebook Files Found</h4>
        <p class="text-muted">The ETL Agent hasn't generated any files yet, or the files couldn't be loaded.</p>
        <a href="{{ url_for('story_detail', story_id=story.id) }}" class="btn btn-azure">
            <i class="fas fa-arrow-left"></i> Back to Story
        </a>
    </div>
</div>
{% endif %}

<!-- Usage Instructions -->
<div class="card">
    <div class="card-header">
        <h6><i class="fas fa-info-circle"></i> How to Use Generated Code</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Deployment Steps:</h6>
                <ol>
                    <li><strong>Download Files:</strong> Use the download buttons to save files locally</li>
                    <li><strong>Setup Environment:</strong> Install requirements from requirements.txt</li>
                    <li><strong>Configure:</strong> Update config.yaml with your environment settings</li>
                    <li><strong>Test:</strong> Run the test file to validate functionality</li>
                    <li><strong>Deploy:</strong> Execute the main pipeline script</li>
                </ol>
            </div>
            <div class="col-md-6">
                <h6>Code Features:</h6>
                <ul>
                    <li><i class="fas fa-check text-success"></i> Production-ready PySpark code</li>
                    <li><i class="fas fa-check text-success"></i> Comprehensive error handling</li>
                    <li><i class="fas fa-check text-success"></i> Configuration management</li>
                    <li><i class="fas fa-check text-success"></i> Unit test framework</li>
                    <li><i class="fas fa-check text-success"></i> Logging and monitoring</li>
                    <li><i class="fas fa-check text-success"></i> Documentation and comments</li>
                </ul>
            </div>
        </div>
        
        <div class="alert alert-info mt-3">
            <i class="fas fa-lightbulb"></i>
            <strong>Tip:</strong> Review and customize the generated code according to your specific environment and requirements before deployment.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showFile(filename) {
    // Hide all file contents
    document.querySelectorAll('.file-content').forEach(el => {
        el.style.display = 'none';
    });
    
    // Show selected file
    document.getElementById('file-' + filename).style.display = 'block';
    
    // Update button states
    document.querySelectorAll('.btn-outline-primary').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    event.target.classList.remove('btn-outline-primary');
    event.target.classList.add('btn-primary');
}

function copyToClipboard(filename) {
    const content = document.getElementById('content-' + filename);
    const textToCopy = content.textContent || content.innerText;
    
    navigator.clipboard.writeText(textToCopy).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(err => {
        alert('Failed to copy to clipboard');
    });
}

function downloadFile(filename) {
    const content = document.getElementById('content-' + filename);
    const textToDownload = content.textContent || content.innerText;
    
    const blob = new Blob([textToDownload], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Syntax highlighting (basic)
document.addEventListener('DOMContentLoaded', function() {
    // Add basic syntax highlighting classes
    document.querySelectorAll('pre code').forEach(block => {
        // Simple keyword highlighting for Python
        let html = block.innerHTML;
        html = html.replace(/\b(def|class|import|from|if|else|elif|for|while|try|except|finally|with|as|return|yield|lambda|and|or|not|in|is|True|False|None)\b/g, '<span style="color: #0066cc; font-weight: bold;">$1</span>');
        html = html.replace(/\b(spark|DataFrame|Column|Row)\b/g, '<span style="color: #cc6600; font-weight: bold;">$1</span>');
        html = html.replace(/#[^\n]*/g, '<span style="color: #008000; font-style: italic;">$&</span>');
        html = html.replace(/\"[^\"]*\"|\'[^\']*\'/g, '<span style="color: #cc0000;">$&</span>');
        block.innerHTML = html;
    });
});
</script>
{% endblock %}